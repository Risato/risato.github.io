<!DOCTYPE html>
<meta charset="utf-8" />
<html>
<head>
 <!-- Leaflet Base -->
 <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.js" ></script>
 <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.css" />

 <!-- Jquery -->
 <script src="https://code.jquery.com/jquery-1.10.1.min.js" ></script>
 <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js" ></script>
 <script src="https://code.jquery.com/jquery-migrate-1.2.1.min.js" ></script>
 <!--[if lte IE 8] ><link rel="stylesheet" href="http://leaflet.cloudmade.com/dist/leaflet.ie.css" / ><![endif]-->

 <!--  group layer control -->
 <script src="https://cdn.rawgit.com/ismyrnow/Leaflet.groupedlayercontrol/gh-pages/src/leaflet.groupedlayercontrol.js"></script>
 <link rel="stylesheet" href="https://cdn.rawgit.com/ismyrnow/Leaflet.groupedlayercontrol/gh-pages/src/leaflet.groupedlayercontrol.css" />

 <!-- font aswesome icons used in social plugin-->
 <link href="https://netdna.bootstrapcdn.com/font-awesome/3.1.1/css/font-awesome.css" rel="stylesheet" />

 <!-- maki markers-->
 <script src="https://cdn.rawgit.com/jseppi/Leaflet.MakiMarkers/master/Leaflet.MakiMarkers.js" ></script>

 <!-- leaflet hash for social integration-->
 <script type='text/javascript' src="https://cdn.rawgit.com/mlevans/leaflet-hash/master/leaflet-hash.js" ></script>

 <!-- context menu plugin -->
 <script src="https://aratcliffe.github.io/Leaflet.contextmenu/dist/leaflet.contextmenu.js" ></script>
 <link rel="stylesheet" href="https://aratcliffe.github.io/Leaflet.contextmenu/dist/leaflet.contextmenu.css"/>

 <!-- GEOCONTROL - geocontrol search box script -->
 <script src="https://smeijer.github.io/GeoSearch/js/l.control.geosearch.js" ></script>
 <script src="https://smeijer.github.io/GeoSearch/js/l.geosearch.provider.google.js" ></script>
 <link rel="stylesheet" href="https://smeijer.github.io/GeoSearch/css/l.geosearch.css" />

 <!-- marker cluster script -->
 <link rel="stylesheet" href="https://leaflet.github.io/Leaflet.markercluster/dist/MarkerCluster.css" />
 <link rel="stylesheet" href="https://leaflet.github.io/Leaflet.markercluster/dist/MarkerCluster.Default.css" />
 <script src="https://leaflet.github.io/Leaflet.markercluster/dist/leaflet.markercluster-src.js" ></script>

 <!-- GOOGLE  - google map plugin -->
 <!-- <script src="https://maps.google.com/maps/api/js?v=3.2&sensor=false" ></script> -->
 <!-- // <script src="http://psha.org.ru/leaflet/plugins/layer/tile/Google.js" ></script> -->
 <!-- // <script src="https://cdn.rawgit.com/DGuidi/1992824.js"></script> -->
 <!-- // <script src="https://gist.githubusercontent.com/crofty/2197042/raw/2b90c41b39b7d5b3a851d8f256de2ebd3fe1fb74/leaflet-google.js"></script> -->
 <!-- // <script type='text/javascript' src="https://gist.githubusercontent.com/crofty/2197042/raw/"></script> -->
 <!-- // <script  type="text/javascript" src="https://gist.githubusercontent.com/AndrewJHart/9766852/raw/2b90c41b39b7d5b3a851d8f256de2ebd3fe1fb74/leaflet-google.js"></script> -->
 <script  type="text/javascript" src="https://rawgit.com/AndrewJHart/9766852/raw/2b90c41b39b7d5b3a851d8f256de2ebd3fe1fb74/leaflet-google.js"></script>
 <!-- // <script type='text/plain' src="https://gist.githubusercontent.com/crofty/2197042/raw/"></script> -->
 <script type="text/javascript" src="https://stamen-maps.a.ssl.fastly.net/js/tile.stamen.js" ></script>

 <!-- MINIMAP Plugins -->
 <link rel="stylesheet" href="https://norkart.github.io/Leaflet-MiniMap/Control.MiniMap.css" />
 <script src="https://norkart.github.io/Leaflet-MiniMap/Control.MiniMap.js" type="text/javascript" ></script>

 <!-- Omnivore Script -->
 <script src='https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-omnivore/v0.2.0/leaflet-omnivore.min.js' ></script>
 <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no' />

 <!-- fullscreen scripts -->
 <script src='https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v0.0.1/Leaflet.fullscreen.min.js' ></script>
 <link href='https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v0.0.1/leaflet.fullscreen.css' rel='stylesheet' />

 <!-- zoom slider scripts -->
 <script src='https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-zoomslider/v0.7.0/L.Control.Zoomslider.js' ></script>
 <link href='https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-zoomslider/v0.7.0/L.Control.Zoomslider.css' rel='stylesheet' />

 <!-- leaflet share control https://github.com/makinacorpus/Leaflet.Social/blob/master/example.html -->
 <script type='text/javascript' src="https://makinacorpus.github.io/Leaflet.Social/leaflet.social.js" ></script>
 <link rel="stylesheet" type="text/css" href="https://makinacorpus.github.io/Leaflet.Social/leaflet.social.css" />

  <!-- Leaflet map print scripts. Saved on google drive in folder. No web script link
  <link rel="stylesheet" href="dist/easyPrint.css"/> 
  <script src="dist/jQuery.print.js" ></script>
  <script src="dist/leaflet.easyPrint.js" ></script> 
  old print screen scripts
  <script src="http://aratcliffe.github.io/Leaflet.print/dist/leaflet.print.js" ></script>
    <link rel="stylesheet" href="http://aratcliffe.github.io/Leaflet.print/dist/leaflet.print.css"/>
    <script src="http://apps2.geosmart.co.nz/mapfish-print/pdf/info.json?var=printConfig"></script>-->

    <title>Wood Biomass Power and Product Facility Map</title>
    <div id="map" > 
    </div>

    
    <!-- map dimensions -->
    <style type="text/css">
      /*map stylying*/
      #map {
        position:center ;
        width: 950px;
        height: 750px;
        /*      margin: 0 0 1em 0;*/
      }
    </style>
  </head>

  <body>
    <div id='content'>
      <!-- styling for legend -->
      <style type='text/css'>
        .legend {
          box-shadow: 0 0 15px rgba(0,0,0,0.2);
          border-radius: 5px;
          width:190px;
          line-height:1em;
          font-family: Arial;
          font-size:100%;
          background: white;
          padding:8px;
          /*background: rgba(80,80,80,0.3);*/
        }
        .legend h2 {
          font-size:175%;
          opacity: 0.75;
          text-align: left;
          line-height:.5em;
          font-weight: bold;
        }
        .legend h4 {
          line-height: 1.5em;
          font-size: 8.5px;
          color: #999;
          clear: both;
          text-align:center;
        }
        .legend a {
          color: #777;
          font-size:50%;
        }
        .leaflet-control-zoomslider-knob { width:14px; height:6px; }
        .leaflet-container .leaflet-control-zoomslider-body {
          -webkit-box-sizing:content-box;
          -moz-box-sizing:content-box;
          box-sizing:content-box;
        }
      </style>
    </div>

    <script type ="text/javascript">

    // https://github.com/jseppi/Leaflet.MakiMarkers
    L.MakiMarkers.accessToken = "pk.eyJ1IjoicnNhdG9taSIsImEiOiJjaW9sMDZkdjAwMDNldXhtMWllcTF5Z3E3In0.Cd_rMcLMmE1Zl5-jIiN8Hg";
    
    // basemap links below
    var osmlayer = L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
      attribution: '© <a href="http://openstreetmap.org/copyright" target= "blank">OpenStreetMap</a> contributors'}); 
    var terrainlayer = L.tileLayer('http://tile.stamen.com/terrain-background/{z}/{x}/{y}.jpg', {
      attribution: 'Map tiles by <a href="http://stamen.com" target = "blank">Stamen Design</a>, under <a href="http://creativecommons.org/licenses/by/3.0" target = "blank">CC BY 3.0</a>. Data by <a href="http://openstreetmap.org" target = "blank">OpenStreetMap</a>, under <a href="http://creativecommons.org/licenses/by-sa/3.0" target = "blank">CC BY SA</a>.' }); 
    var esrilayer = L.tileLayer('http://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      attribution: '© ESRI <a href="http://www.esri.com/legal/licensing/termsofuse.html" target="blank">(ESRI Terms of Use)</a>' }); 
    // var gmap_layer = new L.Google('ROADMAP');
    // var gmap_layer2 = new L.Google('SATELLITE');
    // var gmap_layer3 = new L.Google('TERRAIN');

  // context menu functions
  function showCoordinates (e) {
    alert(e.latlng);
  }
  function centerMap (e) {
    map.panTo(e.latlng);
  }
  function zoomIn (e) {
    map.zoomIn();
  }
  function zoomOut (e) {
    map.zoomOut();
  }
  
  // zoom bound extents
  var southWest = L.latLng(20, -140),
  northEast = L.latLng(58, -50),
  bounds = L.latLngBounds(southWest, northEast);

  // Add MAP
  var map = L.map('map', {  zoomControl:false,
    // add zoom slider
    zoomsliderControl: true,
  // starting position
  center: [37.208, -120.102],
  zoom: 6,
    // map extent constraints
    minZoom: 4,
    maxBounds: bounds,
  // add contextmenu parameters
  contextmenu: true,
  contextmenuWidth: 140,
  contextmenuItems: [{
    text: 'Show coordinates',
    callback: showCoordinates
  }, {
    text: 'Center map here',
    callback: centerMap
  }, '-', {
    text: 'Zoom in',
    icon: 'Image/zoom_in.png',
    callback: zoomIn
  }, {
    text: 'Zoom out',
    icon: 'Image/zoom_out.png',
    callback: zoomOut
  }]
});

//  social media integration
var hash = new L.Hash(map);
L.control.social({position:'topleft', default_text: "Learn about California's bioenergy potential! #Bioenergy #California #Forestry"}).addTo(map);

// adds a scale to map
L.control.scale({
  metric:false,
  position: 'bottomleft'
});

// newer print function. temp disabled
// L.easyPrint().addTo(map);

// outdated print control
//  var printProvider = L.print.provider({
//   capabilities: printConfig,
//   method: 'GET',
//   dpi: 254,
//   outputFormat: 'pdf',
//   customParams: {
//     mapTitle: 'Print Test',
//     comment: 'Testing Leaflet printing'
//   }
// });

//     // Create a print control with the configured provider and add to the map
//     var printControl = L.control.print({
//       provider: printProvider
//     });
//     map.addControl(printControl);

// LAYERS DEFINED BELOW. STRUCTURED SO THAT each layer shows only the filtered icons and them merges them together. 
// duplicates two layers and merges them together
// https://docs.google.com/spreadsheet/pub?key=0AnyNiqk9X8DmdDJneGxsNTB6cFFQamRMX0VuNjhPQ2c&single=true&gid=1&output=csv
var Biomasslayer = 
omnivore.csv('/CommunityBiomassGroup.csv').addTo(map)
.on('layeradd',function(e) {
  var powermarker = e.layer;
  var feature = powermarker.feature;
  var powercontent = 
  '<h1>' + '<font color="2C49BO">' +feature.properties.MapLabel + '</font>'+ '</h1>' + '<hr>' +
  '<b>Location: </b>' + feature.properties.City +', ' + feature.properties.State +'<br>' +
  '<b>Facility Type: </b>' + feature.properties.Project_Type + ', '+feature.properties.Cogen_Status + '<br>' +
  '<b>Output: </b>' + feature.properties.MWname + ' MW '+'<br>' +
  '<b>Status: </b>' + feature.properties.Status + '<br>' +
  '<b>Alternative Names: </b>' + feature.properties.OldName;

  powermarker.bindPopup(powercontent, {
    closeButton: true,
    minWidth:320 });

  powermarker.feature.properties['marker-size'] = 'medium';

  if (powermarker.feature.properties.Status ==='Operational')
  {
    if (powermarker.feature.properties.Cogen_Status ==='cogen')
    {
      powermarker.setIcon(L.icon({
        iconUrl: 'https://docs.google.com/uc?id=0B3yNiqk9X8DmSzNaSzJYRDUzRFE&amp;export-png',
        // iconUrl: '/Marker/Custom/MapIcon/Operational_target.png',
        iconSize: [25,25]
      }));
    }
    else
    {
      powermarker.setIcon(L.icon({
        iconUrl: 'https://docs.google.com/uc?id=0B3yNiqk9X8DmSURaM3ZjZkswNzA&amp;export-png',
        // iconUrl: '/Marker/Custom/MapIcon/Operational.png',
        iconSize: [25,25]
      }));
    }
  }
  else if (powermarker.feature.properties.Status === 'Active Project')
  {    
    if (powermarker.feature.properties.Cogen_Status === 'cogen')
    {
      powermarker.setIcon(L.icon({
        iconUrl: 'https://docs.google.com/uc?id=0B3yNiqk9X8DmYzYxcWRYY0NDZ3M&amp;export-png',
        // iconUrl: '/Marker/Custom/MapIcon/Develop_target.png',
        iconSize: [25,25]
      }));
    }
    else
    {
      powermarker.setIcon(L.icon({
        iconUrl: 'https://docs.google.com/uc?id=0B3yNiqk9X8DmcS1NdTFCbnhvb3M&amp;export-png',
        // iconUrl: '/Marker/Custom/MapIcon/Develop.png',
        iconSize: [25,25]
      }));
    }
  }
  else
  {        
    powermarker.setIcon(L.icon({
      iconUrl: 'https://docs.google.com/uc?id=0B3yNiqk9X8DmSllLWFk5VjllZm8&amp;export-png',
      // iconUrl: '/Marker/Custom/MapIcon/filler.png',
      iconSize: [0,0]
    }));
  };


// GEOCONTROL - gets url parameters
function getURLParameter(name) {
  return decodeURI(
    (RegExp(name + '=' + '(.+?)(&|$)').exec(location.search)||[,])[1]
    );
}
var regionParameter = getURLParameter('region');
var region = (regionParameter === 'undefined') ? '' : regionParameter;


// GEOCONTROL - add geolocation search box
new L.Control.GeoSearch({
  provider: new L.GeoSearch.Provider.Google({
    region: region
  })
}).addTo(map);
</script>
</body>
</html>